---
import Layout from '../../layouts/Layout.astro';
import Sidebar from '../../components/Sidebar.astro';
// CORREÇÃO: Usando o nome exato que está no seu arquivo lib/sanity.ts
import { sanityClient } from '../../lib/sanity';

// 1. Busca as categorias existentes no Sanity
export async function getStaticPaths() {
  const categories = await sanityClient.fetch(`*[_type == "category"]{
    "slug": slug.current,
    title
  }`);

  return categories.map((cat) => ({
    params: { category: cat.slug },
    props: { name: cat.title },
  }));
}

const { category } = Astro.params;
const { name } = Astro.props;

// 2. Busca as notícias REAIS dessa categoria
const posts = await sanityClient.fetch(`
  *[_type == "post" && $category in categories[]->slug.current] | order(publishedAt desc) {
    title,
    "slug": slug.current,
    "image": mainImage.asset->url,
    "excerpt": body[0].children[0].text
  }
`, { category });
---

<Layout title={`Notícias sobre ${name}`}>
    <div class="relative py-16 mb-12 border-b border-white/5 bg-bj-surface/50 overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 relative z-10 text-center">
            <span class="text-bj-neon text-xs font-bold uppercase tracking-[0.2em] mb-3 block">Categoria</span>
            <h1 class="text-5xl md:text-7xl font-heading font-bold text-bj-white uppercase tracking-tighter">
                {name}
            </h1>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 max-w-7xl mx-auto px-4">
        <div class="lg:col-span-8 grid grid-cols-1 md:grid-cols-2 gap-8">
            {posts.length > 0 ? (
                posts.map((post) => (
                    <article class="group flex flex-col h-full bg-bj-surface border border-white/5 rounded-sm overflow-hidden">
                        <a href={`/posts/${post.slug}`} class="aspect-video overflow-hidden relative">
                             {post.image ? (
                                <img src={post.image} alt={post.title} class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                             ) : (
                                <div class="w-full h-full bg-gray-800 flex items-center justify-center text-gray-600">Sem imagem</div>
                             )}
                        </a>
                        <div class="p-6 flex flex-col flex-grow">
                            <h2 class="text-xl font-heading font-bold text-bj-white leading-tight mb-3 group-hover:text-bj-neon transition-colors">
                                <a href={`/posts/${post.slug}`}>{post.title}</a>
                            </h2>
                            <p class="text-bj-dim text-sm line-clamp-3 mb-4 flex-grow">
                                {post.excerpt ? post.excerpt : "Clique para ler a notícia completa..."}
                            </p>
                        </div>
                    </article>
                ))
            ) : (
                <div class="col-span-2 text-center text-bj-dim py-12">
                    <p>Nenhuma notícia encontrada nesta categoria ainda.</p>
                </div>
            )}
        </div>
        <aside class="lg:col-span-4">
            <Sidebar />
        </aside>
    </div>
</Layout>